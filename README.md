# dt-ib-tools
Additional 1C:EDT tools for 1C:Entreprise infobase manipulations

## generate-ib-sync-state
Команда для принудительной генерации состояния синхронизации информационной базы 1С:Предприятия и проекта 1С:EDT для 1C:EDT версий 2025.2+

Данная команда может использоваться для принудительной синхронизации новой информационной базы и заданного состояния проекта 1С:EDT при следующих условиях:
* Новая информационная база являеется полной копией некоторой исходной инфобазы X в состоянии X1 (новая информационная база создана восстановлением дампа исходной информационной базы или проведена полная загрузка cf-файла)
* Исходные коды проекта Y 1С:EDT находится в состоянии Y1
* Ранее проект Y был полностью синхронизирован с оригинальной информационной базой X, и на момент старта и завершения синхронизации они имели состояния соответственно Y1 и X1
В случае, если указанные условия не выполнены полностью или частично, генерируемое состояние синхронизации может и будет приводить к ошибкам синхронизации 1С:EDT и соответствующей информационной базы

Типичные сценарии использования:
* Ранее было создано некоторое опорное состояние проекта 1C:EDT (обычно в виде ветки/коммита/тега в репозитории Git) и соответствующее состояние тестовой информационной базы
* Далее создается рабочая ветка от указанного опорного состояния (ветки/коммита) для проведения каких-то работ
* Также создается новая информационная база (обычно - тестовая), содержимое которой загружается из соответствующего сохраненого состояния
* И для того, чтобы не тратить время на формальную синхронизацию данных проекта и информационной базы (для больших проектов - это серьезные затраты времени), производится прямая замена хранимого состояния синхронизации проекта 1C:EDT и соответствующей информационной базы

Пример:
```
generate-ib-sync-state --project X:/test/bsp --cdi X:/test/ConfigDumpInfo.xml --gen-id 6d1854a9ee07804a820f4a081f6a40e400000000 --ib-uuid 73e63dd3-3285-45a7-b7e5-d113f81dc2be --target X:/test/target 
```

ConfigDumpInfo.xml и GenerationId могут быть получен путем вызова соответствующих команд через CLI конфигуратора 1С:Предприятие (/DumpConfigToFiles -configDumpInfoOnly и  /GetConfigGenerationID соотвественно)

Генерируемое состояние должно быть скопировано в рабочий каталог состояний синхронизации (<UserHome>\AppData\Roaming\.1cedt\ib-sync\ss (или %APPDATA%\.1cedt\ib-sync\ss) для Windows и %user.home%\.1cedt\ib-sync\ss для Linux и Mac) при неактивном процессе 1C:EDT до создания нового приложения для целевого проекта и информационной базы.

Поддерживается инкрементальная генерация (с перезаписью) состояния синхронизации для проекта и его расширений, хранящихся в соответствующей информационной базе. Для этого необходимо запустить данную команду для каждого расширения, с предоставлением его ConfigDumpInfo.xml и GenerationId

### Краткое описание концепции синхронизации в 1C:EDT 2025.2+
Поскольку предлагаемая команда предназначена для временного решения в составе уже существующих процессов разработки (в дальейшем планируется разработка нативного решения 1С:EDT, более эффективного с т.з. паразитных затрат времени), достаточно полезным будет краткое описание текущей концепции синхронизации 1С:EDT для понимания последствий внесения несинхронизированных изменений в рассматриваемый индекс синхронизации.

Концепция новой схемы синхронизации весьма проста, и она принципиально ИБ-центрична. Причина - нам всегда нужно знать, что нужно загрузить из ИБ/в ИБ в любой момент времени во время работы с ИБ, связанной с проектом 1С:EDT. 
При этом - по возможности в минимальном объеме. При этом с т.з. ИБ совершенно не важно, из какого проекта 1C:EDT она получает данные, или в какой проект она их отдает.
Исходя из этих требований, была разработана следующая концепция:

* В ИБ хранятся метаданные (в широком смысле, включая все типы объектов конфигурации, с которыми и работает EDT) и непосредственно данные (структура которых аффектируются изменениями в метаданных)
* В 1С:EDT хранятся только метаданные (опять же в широком смысле, в формате 1С:EDT, но концептуально совместимые с платформенными, по крайней мере в том объеме, в котором идет обмен данными с платформой 1C:Предприятие)
* В момент синхронизации данных между ИБ и 1С:EDT мы условно получаем точку, где мы (с помощью механизмов синхронизации, блокировок и т.п.) точно знаем состояние метаданных в ИБ и в 1C:EDT
* А теперь вспоминаем, что у нас ИБ-центричный подход. И фактически в этой точке мы получаем два набора данных - состояние данных в ИБ и состояние _строго соответствующих_ им данных 1С:EDT
* И именно это состояние мы и фиксируем в качестве последнего известного состояния данных в ИБ с т.з. 1C:EDT после последней удачной синхронизации
* В ИБ все объекты версионированы, в т.ч. есть глобальная версия  (generationId). В 1C:EDT все исходники прохэшированы. Фактичеиски это и есть те самые ConfigDumpInfo.xml и index.idx, которые и составляют собой индекс синхронизации ИБ и 1С:EDT
* Как мы видим, индекс синхронизации не содержит никакой специфики конкретного проекта 1C:EDT, поэтому защищены от операций типа очистки данных проекта, переприсоединения к другому проекту, и т.п.
* Это же вносит и определенные коррективы в ранее проекто-центричные операции. Теперь в рамках этих операций должен быть предоставлен дополнительный контекст для операции синхронизации (например - требования безусловной синхронизации данных). Однако в общем это практически не сказывается на UX 1С:EDT, так как такие операции и так имеют вполне очевидный для пользователя контекст.

Теперь рассмотрим основные сценарии возникновения изменений с обеих сторон, и как в этом случае должна работать данная схема синхронизации (все сценарии относительно последнего удачногосостояния синхронизации, зафиксированного для ИБ способом, указанным выше):
* Изменения на стороне ИБ, в 1C:EDT - нет
  * Мы сравниваем актуальный generationId в ИБ и в ConfigDumpInfo.xml нашего сохраненного состояния. Одинаковы? Значит изменений нет
  * Различаются? Значит подаем наш ConfigDumpInfo.xml и получаем дельту. Не важно, кто и как изменил данные в ИБ. Главное - какие
  * Мы их обрабатываем, расширяем скоупы импорта по правилам платформы и загружаем только эти изменения в проект 1C:EDT. Разумеется с объединением, но техническим - поскольку мы знаем, что состояние проекта 1С:EDT не менялось с момента последней синхронизации. Т.е. не нужно вызывать редактор сравнения.
  * В результате получаем полностью синхронизированный проект

* Изменения на стороне 1C:EDT, в ИБ - нет
  * Мы берем данные из index.idx и сверяем состояние исходников проекта 1C:EDT с сохраненным по хэшам
  * Все измененные файлы транслируются в соответствующие (и зависимые) объекты 1C:EDT, точно так же расширяются скоупы публикации по правилам платфомры, и результат уходит (после конвертации в XML платформы) в ИБ
  * В результате получаем полностью синхронизированный проект

* Изменения с обеих сторон
  * То же самое, что и ранее, но пользователь должен выбрать один из вариантов - импорт из ИБ с объединением, или перезапись ИБ из 1C:EDT
  * Далее все так же, но по результатам сравнения и объединения в случае импорта из ИБ с объединением проект останется рассинхронизированным. Почему? Опять же совершенно логично, в ИБ и в 1С:EDT данные все еще различаются. В 1C:EDT часть данных теперь является объединением изменений 1C:EDT и ИБ, часть - уникальные изменения в 1C:EDT (те, которые напрямую не конфликтовали).
  * И для получения статуса полной синхронизации необходима публикация изменений проекта 1С:EDT в ИБ
